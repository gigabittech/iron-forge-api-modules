"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.assertValueNonNull=assertValueNonNull;exports.assertValueNonEmptyString=assertValueNonEmptyString;exports.guardIsAuthenticated=guardIsAuthenticated;exports.guardIsAuthProviderAuthenticated=guardIsAuthProviderAuthenticated;exports.genAuthenticationGuardApolloServerPlugin=genAuthenticationGuardApolloServerPlugin;exports.descendantFieldValuesDiffSetIsLengthZero=descendantFieldValuesDiffSetIsLengthZero;exports.descendantFieldValuesIncludePrefix=descendantFieldValuesIncludePrefix;exports.genFnCheckDescendantFieldsForPrefix=genFnCheckDescendantFieldsForPrefix;exports.childFieldValuesDiffSetIsLengthZero=childFieldValuesDiffSetIsLengthZero;const lodash_1=__importDefault(require("lodash"));function assertValueNonNull(value,errorMessage){if(lodash_1.default.isNil(value)){throw new Error(errorMessage??"CANNOT_RETRIEVE")}return value}function assertValueNonEmptyString(value,errorMessage){if(!value){throw new Error(errorMessage??"CANNOT_RETRIEVE")}return value}function guardIsAuthenticated(context){if(!context.base.userId){throw new Error("ACCESS_DENIED")}}function guardIsAuthProviderAuthenticated(context){if(!context.base.authProviderUserId){throw new Error("ACCESS_DENIED")}}function genAuthenticationGuardApolloServerPlugin({graphqlPath2GuardType:graphqlPath2GuardType,debugMode:debugMode}){const plugin={requestDidStart:async()=>({executionDidStart:async()=>({willResolveField:({contextValue:contextValue,info:info})=>{const possiblePathKeys=__calcPossiblePathKeysFromInfo(info.path);if(debugMode){console.debug(`Info path: ${__calcGraphqlPathFromInfo(info.path)}`);console.debug("Possible path keys:");lodash_1.default.forEach(possiblePathKeys,(key=>{console.debug(`- ${key}`)}))}const finalGuardType=lodash_1.default.reduce(possiblePathKeys,((guardType,possiblePathKey)=>graphqlPath2GuardType[possiblePathKey]??guardType),"requireSiteUser");if(debugMode){console.debug(`Final guard type: ${finalGuardType}`)}if(finalGuardType==="requireSiteUser"){guardIsAuthenticated(contextValue)}else if(finalGuardType==="requireAuthProviderUser"){guardIsAuthProviderAuthenticated(contextValue)}}})})};return plugin}function __calcPossiblePathKeysFromInfo(infoPath){const path=__calcGraphqlPathFromInfo(infoPath);const nodes=path.split(".");const{possiblePathKeys:possiblePathKeys}=lodash_1.default.reduce(nodes,((intermediateStep,node,index,list)=>{const isAnIndex=__isKeyAnIndex(node);const nodeKey=isAnIndex?"*":node;const pathPrefix=intermediateStep.pathPrefix?`${intermediateStep.pathPrefix}.${nodeKey}`:nodeKey;const isLast=index===list.length-1;const possiblePathKeys=[...intermediateStep.possiblePathKeys,!isLast?`${pathPrefix}.*`:pathPrefix];return{pathPrefix:pathPrefix,possiblePathKeys:possiblePathKeys}}),{pathPrefix:"",possiblePathKeys:[]});return possiblePathKeys}function __calcGraphqlPathFromInfo(infoPath){const reverseNodes=[];let node=infoPath;let previousNode=undefined;do{reverseNodes.push(node.key.toString());previousNode=node;node=node.prev}while(node);const nodes=[previousNode.typename,...lodash_1.default.reverse(reverseNodes)];return nodes.join(".")}function __isKeyAnIndex(key){const nKey=+key||0;const sKey=nKey.toString();return key===sKey&&lodash_1.default.isInteger(nKey)&&nKey>=0}function __parseGqlInfo(info){const fragmentMap=info.fragments;const selectionSetNode=info.fieldNodes[0]?.selectionSet??null;return{fragmentMap:fragmentMap,selectionSetNode:selectionSetNode}}function __getChildFieldValues(fragmentMap,selectionSetNode){const selections=__resolveFragmentSpreads(fragmentMap,selectionSetNode);return lodash_1.default.compact(lodash_1.default.map(selections,(selection=>selection.kind==="Field"?selection.name.value:"")))}function __resolveFragmentSpreads(fragmentMap,selectionSetNode){return lodash_1.default.flatten(lodash_1.default.map(selectionSetNode?.selections,(selection=>{if(selection.kind!=="FragmentSpread"){return selection}const fragmentName=selection.name.value;const fragment=fragmentMap[fragmentName];if(!fragment){throw new Error(`FRAGMENT_NOT_FOUND ${fragmentName}`)}return fragment.selectionSet.selections})))}function __getDescendantFieldValues(fragmentMap,selectionSetNode,prefix=""){const selections=__resolveFragmentSpreads(fragmentMap,selectionSetNode);const leafValues=lodash_1.default.compact(lodash_1.default.map(selections,(selection=>selection.kind==="Field"&&(!selection.selectionSet||selection.selectionSet.selections.length===0)?selection.name.value:"")));const prefixedLeafValues=prefix?lodash_1.default.map(leafValues,(value=>`${prefix}.${value}`)):leafValues;const childSelections=lodash_1.default.filter(selections,(selection=>selection.kind==="Field"&&!!selection.selectionSet&&selection.selectionSet.selections.length>0));const childSelectionSetMap=lodash_1.default.zipObject(lodash_1.default.map(childSelections,(selection=>selection.kind==="Field"?selection.name.value:"")),lodash_1.default.map(childSelections,(selection=>selection.kind==="Field"?selection.selectionSet:null)));const filteredChildSelectionSetMap=lodash_1.default.pickBy(childSelectionSetMap,((value,key)=>value!==null&&key.length>0));return[...prefixedLeafValues,...lodash_1.default.flatten(lodash_1.default.map(filteredChildSelectionSetMap,((selectionSet,name)=>__getDescendantFieldValues(fragmentMap,selectionSet,__genPrefix(prefix,name)))))]}function __getDescendantFieldValuesFromInfo(info){const{fragmentMap:fragmentMap,selectionSetNode:selectionSetNode}=__parseGqlInfo(info);return __getDescendantFieldValues(fragmentMap,selectionSetNode)}function descendantFieldValuesDiffSetIsLengthZero({info:info,matchSet:matchSet,ignoreFieldsWithPrefixes:ignoreFieldsWithPrefixes}){const descendantFieldValues=__getDescendantFieldValuesFromInfo(info);const filteredFieldValues=ignoreFieldsWithPrefixes?lodash_1.default.filter(descendantFieldValues,(value=>!lodash_1.default.some(ignoreFieldsWithPrefixes,(prefix=>value.startsWith(prefix))))):descendantFieldValues;const diff=lodash_1.default.difference(filteredFieldValues,matchSet);return diff.length===0}function __genPrefix(currentPrefix,name){return currentPrefix?`${currentPrefix}.${name}`:name}function descendantFieldValuesIncludePrefix({info:info,prefix:prefix}){const descendantFieldValues=__getDescendantFieldValuesFromInfo(info);return lodash_1.default.some(descendantFieldValues,(value=>value.startsWith(prefix)))}function genFnCheckDescendantFieldsForPrefix(info){return prefix=>descendantFieldValuesIncludePrefix({info:info,prefix:prefix})}function childFieldValuesDiffSetIsLengthZero({info:info,matchSet:matchSet}){const{fragmentMap:fragmentMap,selectionSetNode:selectionSetNode}=__parseGqlInfo(info);const childFieldValues=__getChildFieldValues(fragmentMap,selectionSetNode);const filteredChildFieldValues=lodash_1.default.filter(childFieldValues,(value=>value!=="__typename"));const diff=lodash_1.default.difference(filteredChildFieldValues,matchSet);return diff.length===0}