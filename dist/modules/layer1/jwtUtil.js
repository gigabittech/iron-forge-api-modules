"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k]}}}Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:true,value:v})}:function(o,v){o["default"]=v});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=="default"&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:true});exports.init=init;exports.decodeJwt=decodeJwt;const lodash_1=__importDefault(require("lodash"));const jose=__importStar(require("jose"));const node_fetch_1=__importDefault(require("node-fetch"));let __config=null;function init(config){__config=config}function __getConfig(){if(!__config){throw new Error("MODULE_NOT_INITIALIZED: jwtUtil")}return __config}async function decodeJwt(accessToken){const{kid:kid}=jose.decodeProtectedHeader(accessToken);if(!kid){throw new Error("INVALID_ACCESS_TOKEN")}const publicKey=await __getPublicKey(kid);const{payload:payload}=await jose.jwtVerify(accessToken,await jose.importJWK(publicKey));if(!payload){throw new Error("CORRUPT_PAYLOAD")}if(payload.iss!==__genCorrectIss()){throw new Error("INVALID_ISS")}if(payload.token_use!=="access"){throw new Error("TOKEN_IS_NOT_ACCESS_TOKEN")}const authProviderUserId=payload.sub??"";if(!authProviderUserId){throw new Error("EMPTY_SUB")}return authProviderUserId}async function __genPublicKeyUrl(){const config=__getConfig();return`https://cognito-idp.${config.aws.cognito.region}.amazonaws.com/${config.aws.cognito.userPoolId}/.well-known/jwks.json`}let __publicKeyCache=Promise.resolve({});async function __getPublicKey(keyId){let cache=await __publicKeyCache;let publicKey=cache[keyId];if(!publicKey){__publicKeyCache=__requestPublicKeysByKeyId();cache=await __publicKeyCache;publicKey=cache[keyId];if(!publicKey){throw new Error("CANNOT_FIND_PUBLIC_KEY")}}return publicKey}async function __requestPublicKeysByKeyId(){const response=await(0,node_fetch_1.default)(await __genPublicKeyUrl());const object=await response.json();return lodash_1.default.keyBy(object.keys,"kid")}function __genCorrectIss(){const config=__getConfig();return`https://cognito-idp.${config.aws.cognito.region}.amazonaws.com/${config.aws.cognito.userPoolId}`}